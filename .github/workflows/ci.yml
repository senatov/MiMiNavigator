name: CI — MiMiNavigator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-quality:
    name: Build & Quality (macOS 26 / Xcode 26.2)
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show versions
        run: |
          xcodebuild -version
          swift --version

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Build (Debug)
        run: |
          xcodebuild clean build \
            -project MiMiNavigator.xcodeproj \
            -scheme MiMiNavigator \
            -configuration Debug \
            -destination 'platform=macOS' \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
          | xcbeautify --renderer github-actions

      - name: Run tests
        # xcodebuild test на Xcode 26 известны зависания — ставим жёсткий таймаут
        timeout-minutes: 15
        continue-on-error: true
        run: |
          xcodebuild test \
            -project MiMiNavigator.xcodeproj \
            -scheme MiMiNavigator \
            -configuration Debug \
            -destination 'platform=macOS' \
            CODE_SIGNING_ALLOWED=NO \
          | xcbeautify --renderer github-actions

      - name: SwiftLint
        continue-on-error: true
        run: |
          if ! command -v swiftlint &>/dev/null; then
            brew install swiftlint
          fi
          swiftlint lint --strict

      - name: Swift-format lint
        continue-on-error: true
        run: xcrun swift-format lint --recursive GUI/Sources

      - name: Summary
        if: always()
        run: |
          echo "### ✅ CI finished" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: macOS 26 (Tahoe)" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode: 26.2" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
