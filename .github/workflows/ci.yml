name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-quality:
    name: Build, Test & Quality Checks
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 16.1
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Display versions
      run: |
        echo "Xcode version:"
        xcodebuild -version
        echo "\nSwift version:"
        swift --version

    - name: Install xcpretty
      run: gem install xcpretty

    - name: Build project
      run: |
        xcodebuild clean build \
          -project MiMiNavigator.xcodeproj \
          -scheme MiMiNavigator \
          -configuration Debug \
          -destination 'platform=macOS' \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty

    - name: Run tests
      run: |
        xcodebuild test \
          -project MiMiNavigator.xcodeproj \
          -scheme MiMiNavigator \
          -configuration Debug \
          -destination 'platform=macOS' \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty
      continue-on-error: true

    - name: SwiftLint check
      run: |
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --strict
        else
          echo "SwiftLint not found in Xcode, installing..."
          brew install swiftlint
          swiftlint lint --strict
        fi
      continue-on-error: true

    - name: Swift-format check
      run: |
        if command -v swift-format &> /dev/null; then
          swift-format lint --recursive Gui/Sources
        else
          echo "Swift-format available in Xcode 16+"
          xcrun swift-format lint --recursive Gui/Sources
        fi
      continue-on-error: true

    - name: Build summary
      if: always()
      run: |
        echo "âœ… Build completed"
        echo "ðŸ“Š All quality checks finished"
